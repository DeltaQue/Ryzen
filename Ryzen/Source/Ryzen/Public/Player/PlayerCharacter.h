// Fill out your copyright notice in the Description page of Project Settings.

#pragma once

#include "Engine.h"
#include "Player/RyzenBaseCharacter.h"
#include "Interactable.h"
#include "Bullet.h"
#include "PlayerCharacter.generated.h"


UCLASS(config = Game)
class APlayerCharacter : public ARyzenBaseCharacter
{
	GENERATED_BODY()

private:
	//  meta = (AllowPrivateAccess = "true")는 디테일 편집 가능
	/** Camera boom positioning the camera behind the character */
	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = Camera, meta = (AllowPrivateAccess = "true"))
		class USpringArmComponent* CameraBoom;

	/** Follow camera */
	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = Camera, meta = (AllowPrivateAccess = "true"))
		class UCameraComponent* FollowCamera;

	//아이템 수집 반경체크 구체
	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = Camera, meta = (AllowPrivateAccess = "true"))
		class USphereComponent* CollectionSphere;


	/* Bullet이 발사되는 위치 */
	UPROPERTY(VisibleDefaultsOnly, Category = Mesh)
		class USceneComponent* MuzzleLocation;

	//Bullet이 발사될 대략적 위치
	FVector GunOffset;
	FVector CameraOffset;

	float LastNoiseLoudness;

	float LastMakeNoiseTime;

	//Fire Function
	void OnFire();


public:
	APlayerCharacter(const class FObjectInitializer& ObjectInitializer);

	virtual void Tick(float DeltaTime) override;

	/** Base turn rate, in deg/sec. Other scaling may affect final turn rate. */
	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = Camera)
		float BaseTurnRate;

	/** Base look up/down rate, in deg/sec. Other scaling may affect final rate. */
	UPROPERTY(VisibleAnywhere, BlueprintReadOnly, Category = Camera)
		float BaseLookUpRate;

	UPROPERTY(VisibleAnywhere, BlueprintReadOnly)
		bool JumpButtonDown;

	UFUNCTION(BlueprintCallable, Category = "AI")
		void MakePawnNoise(float Loudness);

protected:

	/** Resets HMD orientation in VR. */
	void OnResetVR();

	/** Called for forwards/backward input */
	void MoveForward(float Value);

	/** Called for side to side input */
	void MoveRight(float Value);

	/**
	* Called via input to turn at a given rate.
	* @param Rate	This is a normalized rate, i.e. 1.0 means 100% of desired turn rate
	*/
	void TurnAtRate(float Rate);

	/**
	* Called via input to turn look up/down at a given rate.
	* @param Rate	This is a normalized rate, i.e. 1.0 means 100% of desired turn rate
	*/
	void LookUpAtRate(float Rate);

	/** Handler for when a touch input begins. */
	void TouchStarted(ETouchIndex::Type FingerIndex, FVector Location);

	/** Handler for when a touch input stops. */
	void TouchStopped(ETouchIndex::Type FingerIndex, FVector Location);


	/** Collection Sphere 범위 내에 AutoPickup 가능한 물체가 있다면 습득  */
	void CollectAutoPickups();


	/** Collection Sphere 범위 내 캐릭터 시야(마우스포인터)에 상호작용 가능한 물체가 있는지 판단 */
	void CheckForInteractables();


protected:
	// APawn interface
	virtual void SetupPlayerInputComponent(class UInputComponent* PlayerInputComponent) override;
	// End of APawn interface

	virtual void BeginPlay();
public:
	/** Returns CameraBoom subobject **/
	FORCEINLINE class USpringArmComponent* GetCameraBoom() const { return CameraBoom; }
	/** Returns FollowCamera subobject **/
	FORCEINLINE class UCameraComponent* GetFollowCamera() const { return FollowCamera; }

	//Pickup요청 함수
	//void CheckForManualPickup(AInteractable *Things);

	//Fire Animation
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = GamePlay)
		class UAnimMontage* FireAnimation;

	UPROPERTY(VisibleDefaultsOnly)
		class UAnimInstance* AnimInstance;

	//Gun Fire Sound
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = Gameplay)
		class USoundBase* FireSound;

	//Gun Fire Particles Effect
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = Gameplay)
		class UParticleSystem* ParticleFX;

	UPROPERTY(VisibleDefaultsOnly)
		class UParticleSystemComponent* FireParticle;

	/* Character Mesh */
	UPROPERTY(VisibleDefaultsOnly, Category = Mesh)
		class USkeletalMeshComponent* CharacterMesh;

	/* Bullet Class */
	UPROPERTY(EditDefaultsOnly, Category = Bullet)
		TSubclassOf<ABullet> Bullets;
};
